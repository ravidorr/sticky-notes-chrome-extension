import{API_BASE_URL as e}from'./config.js';const t={apiKey:null,currentFilter:'all',refreshInterval:null};function n(e){if(!e)return'';const t=document.createElement('div');return t.textContent=e,t.innerHTML;}function o(e){if(!e)return!1;try{const t=new URL(e);return['http:','https:'].includes(t.protocol);}catch{return!1;}}function a(e){return o(e)?e:'#';}function s(e){if(!e)return'';const t=document.createElement('div');return t.innerHTML=e,t.textContent||t.innerText||'';}function r(e){return e?new Date(e).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}):'Unknown date';}function i(){return{apiKeySection:document.getElementById('apiKeySection'),mainContent:document.getElementById('mainContent'),apiKeyInput:document.getElementById('apiKeyInput'),saveApiKeyBtn:document.getElementById('saveApiKeyBtn'),settingsBtn:document.getElementById('settingsBtn'),urlInput:document.getElementById('urlInput'),loadBtn:document.getElementById('loadBtn'),notesList:document.getElementById('notesList'),status:document.getElementById('status'),autoRefreshCheckbox:document.getElementById('autoRefresh'),filterTabs:document.querySelectorAll('.filter-tab'),keyIndicator:document.getElementById('keyIndicator'),domainSelect:document.getElementById('domainSelect'),userEmailSpan:document.getElementById('userEmail')};}function l(e,t,n){e&&(e.textContent=t,e.className=`status status-${n}`);}function c(e,t){e&&(t&&t.length>16?(e.textContent=`Key: ${t.substring(0,12)}...${t.slice(-4)}`,e.style.display='inline'):e.style.display='none');}function d(e){const{apiKeySection:t,mainContent:n,apiKeyInput:o}=e;t&&(t.style.display='flex'),n&&(n.style.opacity='0.3',n.style.pointerEvents='none'),o&&o.focus();}function u(e){const{apiKeySection:t,mainContent:n}=e;t&&(t.style.display='none'),n&&(n.style.opacity='1',n.style.pointerEvents='auto');}function m(e){const{domainSelect:t,urlInput:n}=e,o=new URLSearchParams(window.location.search).get('url');o&&t&&n&&(t.value='__custom__',n.value=o,n.style.display='block');}function y(e,t){const{domainSelect:n,urlInput:o}=e;n&&('__custom__'===n.value?o&&(o.style.display='block',o.focus()):(o&&(o.style.display='none',o.value=''),t&&t()));}function p(e,t){if(!e)return;const n=e.value;for(;e.options.length>2;)e.remove(1);t.sort().forEach(t=>{const n=document.createElement('option');n.value=t,n.textContent=t,e.insertBefore(n,e.lastElementChild);}),n&&Array.from(e.options).some(e=>e.value===n)&&(e.value=n);}function f(e,t){e&&(0!==t.length?e.innerHTML=t.map(e=>{const t=a(e.url),o=n(e.url);return`\n        <div class="note-card theme-${e.theme||'yellow'}">\n            <div class="note-header">\n                ${e.isShared?`<span class="note-badge" title="Shared by ${n(e.ownerEmail||'unknown')}">Shared by ${n(e.ownerEmail||'unknown')}</span>`:''}\n                <code class="note-selector">${n(e.selector)}</code>\n            </div>\n            <div class="note-url-row">\n                <a href="${t}" target="_blank" rel="noopener noreferrer" class="note-url-link" title="Open in new tab">\n                    ${o}\n                </a>\n                <a href="${t}" target="_blank" rel="noopener noreferrer" class="btn-open" title="Open page"${'#'===t?' style="pointer-events: none; opacity: 0.5;"':''}>\n                    Open\n                </a>\n            </div>\n            <div class="note-content-box">\n                ${n(s(e.content))||'<em class="no-content">No content</em>'}\n            </div>\n            ${e.comments&&e.comments.length>0?`\n            <div class="note-comments">\n                <div class="comments-header">Comments (${e.comments.length})</div>\n                ${e.comments.map(e=>`\n                    <div class="comment ${e.parentId?'comment-reply':''}">\n                        <span class="comment-author">${n(e.authorName||'Unknown')}</span>\n                        <span class="comment-date">${r(e.createdAt)}</span>\n                        <div class="comment-content">${n(e.content)}</div>\n                    </div>\n                `).join('')}\n            </div>\n            `:''}\n            <div class="note-footer">\n                <span class="note-date" title="${e.createdAt}">\n                    ${r(e.createdAt)}\n                </span>\n                <span class="note-id" title="Note ID: ${e.id}">\n                    ${e.id.substring(0,8)}...\n                </span>\n            </div>\n        </div>\n    `;}).join(''):e.innerHTML='<p class="empty-state-msg">No notes found</p>');}function h(e,t,n={}){const{apiKeyInput:o}=e,a=o?.value?.trim();a?(t.apiKey=a,localStorage.setItem('sticky_notes_api_key',a),c(e.keyIndicator,a),u(e),l(e.status,'API key saved!','success'),n.onSuccess&&n.onSuccess()):l(e.status,'Please enter a valid API key','error');}async function g(t,n){if(!t)return null;try{const o=await fetch(`${e}/notes/stats`,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok)return null;const a=await o.json(),s=document.getElementById('statTotal'),r=document.getElementById('statOwned'),i=document.getElementById('statShared'),l=document.getElementById('statDomains');s&&(s.textContent=a.total),r&&(r.textContent=a.owned),i&&(i.textContent=a.shared),l&&(l.textContent=a.domainCount);const c=a.byTheme||{},d=document.getElementById('themeYellow'),u=document.getElementById('themeBlue'),m=document.getElementById('themeGreen'),y=document.getElementById('themePink');d&&(d.style.flex=c.yellow||0),u&&(u.style.flex=c.blue||0),m&&(m.style.flex=c.green||0),y&&(y.style.flex=c.pink||0);const f=document.getElementById('legendYellow'),h=document.getElementById('legendBlue'),g=document.getElementById('legendGreen'),v=document.getElementById('legendPink');return f&&(f.textContent=c.yellow||0),h&&(h.textContent=c.blue||0),g&&(g.textContent=c.green||0),v&&(v.textContent=c.pink||0),a.user?.email&&n.userEmailSpan&&(n.userEmailSpan.textContent=a.user.email+' ',n.userEmailSpan.title=`Signed in as ${a.user.email}`),a.user?.email&&n.keyIndicator&&(n.keyIndicator.textContent=a.user.email,n.keyIndicator.title=`Connected as ${a.user.email}`,n.keyIndicator.style.display='inline'),n.domainSelect&&p(n.domainSelect,a.domains||[]),a;}catch(e){return console.error('Error loading stats:',e),null;}}async function v(t={}){const{apiKey:n,elements:o,currentFilter:a='all',onUnauthorized:s}=t;if(!n)return o&&d(o),[];o?.status&&l(o.status,'Loading notes...','loading');try{let t;const r=new URLSearchParams,i=o?.domainSelect?.value,c=o?.urlInput?.value?.trim();'commented'===a?t=`${e}/notes/commented`:(t=`${e}/notes`,'all'!==a&&r.set('filter',a)),'__custom__'===i&&c?c.startsWith('http://')||c.startsWith('https://')?r.set('url',c):r.set('domain',c):i&&'__custom__'!==i&&r.set('domain',i);const d=r.toString(),u=d?`${t}?${d}`:t,m=await fetch(u,{headers:{Authorization:`Bearer ${n}`}});if(!m.ok){if(401===m.status)return localStorage.removeItem('sticky_notes_api_key'),o?.status&&l(o.status,'Invalid API key. Please enter a valid key.','error'),s&&s(),[];throw new Error(`API error: ${m.status}`);}let y=(await m.json()).notes||[];if('commented'===a&&y.length>0){const t=await Promise.all(y.map(async t=>{try{const o=await fetch(`${e}/notes/${t.id}/comments`,{headers:{Authorization:`Bearer ${n}`}});if(o.ok){const e=await o.json();return{...t,comments:e.comments||[]};}}catch(e){console.error('Error fetching comments for note:',t.id,e);}return{...t,comments:[]};}));y=t;}o?.notesList&&f(o.notesList,y);const p={all:'all',owned:'your',shared:'shared',commented:'commented'}[a];return o?.status&&l(o.status,`Found ${y.length} ${p} note${1!==y.length?'s':''}`,'success'),y;}catch(e){return console.error('Error loading notes:',e),o?.status&&l(o.status,`Error: ${e.message}`,'error'),[];}}function I(e,t,n,o){t.forEach(e=>e.classList.remove('active')),e.classList.add('active'),n.currentFilter=e.dataset.filter,o&&o();}function E(e,t,n){e?t.refreshInterval=setInterval(()=>{n&&n();},5e3):t.refreshInterval&&(clearInterval(t.refreshInterval),t.refreshInterval=null);}function k(e){e.refreshInterval&&(clearInterval(e.refreshInterval),e.refreshInterval=null);}function $(e,t){e.apiKeyInput&&(e.apiKeyInput.value=t||''),d(e);}function B(e,t,n={}){c(e.keyIndicator,t.apiKey),t.apiKey?(u(e),n.onApiKeyValid&&n.onApiKeyValid()):d(e);}function S(e,t,n={}){const{saveApiKeyBtn:o,apiKeyInput:a,loadBtn:s,urlInput:r,domainSelect:i,filterTabs:l,autoRefreshCheckbox:c,settingsBtn:d}=e;o&&o.addEventListener('click',()=>n.onSaveApiKey?.()),a&&a.addEventListener('keypress',e=>{'Enter'===e.key&&n.onSaveApiKey?.();}),s&&s.addEventListener('click',()=>n.onLoadNotes?.()),r&&r.addEventListener('keypress',e=>{'Enter'===e.key&&n.onLoadNotes?.();}),i&&i.addEventListener('change',()=>n.onDomainChange?.()),l&&l.forEach(e=>{e.addEventListener('click',()=>{I(e,l,t,n.onLoadNotes);});}),c&&c.addEventListener('change',e=>{E(e.target.checked,t,n.onRefresh);}),d&&d.addEventListener('click',()=>n.onOpenSettings?.());}function w(e){window.addEventListener('beforeunload',()=>{k(e);});}function K(){t.apiKey=localStorage.getItem('sticky_notes_api_key');const e=i(),n=()=>v({apiKey:t.apiKey,elements:e,currentFilter:t.currentFilter,onUnauthorized:()=>{t.apiKey=null,d(e);}}),o=()=>g(t.apiKey,e),a={onSaveApiKey:()=>h(e,t,{onSuccess:()=>{o(),n();}}),onLoadNotes:n,onDomainChange:()=>y(e,n),onRefresh:()=>{o(),n();},onOpenSettings:()=>$(e,t.apiKey)};m(e),S(e,t,a),w(t),B(e,t,{onApiKeyValid:()=>{o(),n();}});}'undefined'!==typeof document&&('loading'===document.readyState?document.addEventListener('DOMContentLoaded',K):K());export{t as state,n as escapeHtml,o as isValidUrl,a as getSafeUrl,s as stripHtml,r as formatDate,i as getDOMElements,l as showStatus,c as updateKeyIndicator,d as showApiKeySection,u as hideApiKeySection,m as handleUrlParams,y as handleDomainSelectChange,p as populateDomainDropdown,f as renderNotes,h as saveApiKey,g as loadStats,v as loadNotes,I as handleFilterTabClick,E as handleAutoRefreshChange,k as clearRefreshInterval,$ as openSettings,B as checkApiKey,S as setupEventListeners,w as setupCleanup,K as init};