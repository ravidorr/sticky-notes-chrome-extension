<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    
    <title>Generate API Key - Sticky Notes</title>
    <meta name="description" content="Generate an API key to use with Sticky Notes MCP server or dashboard">
    <meta name="robots" content="noindex">
    
    <style>
        .generate-key-page {
            padding-top: 100px;
            min-height: 100vh;
        }
        
        .key-form-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .key-form-card h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .key-form-card p {
            color: var(--muted);
            margin-bottom: 24px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--foreground);
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--background);
            color: var(--foreground);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .result-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            margin: 24px auto 0;
        }
        
        .result-card h3 {
            margin-bottom: 12px;
        }
        
        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            color: #92400e;
        }
        
        [data-theme="dark"] .warning-box {
            background: #422006;
            border-color: #d97706;
            color: #fde68a;
        }
        
        .key-display {
            background: #1f2937;
            color: #10b981;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
            margin-bottom: 16px;
        }
        
        .curl-example {
            background: #1f2937;
            color: #9ca3af;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .error-msg {
            color: #ef4444;
            margin-top: 12px;
        }
        
        .user-info {
            color: var(--muted);
            font-size: 14px;
            margin-top: 8px;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Navigation -->
    <nav id="navbar" class="navbar">
        <div class="container flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2">
                <div class="nav-logo-box">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="1" y="1" width="14" height="14" rx="2" fill="#facc15"/>
                        <path d="M4 5h8M4 8h8M4 11h5" stroke="#713f12" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <span class="logo-text">Sticky Notes</span>
            </a>

            <div class="desktop-menu items-center gap-8">
                <a href="index.html#features" class="nav-link">Features</a>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="https://github.com/ravidorr/sticky-notes-chrome-extension" target="_blank" rel="noopener" class="nav-link">GitHub</a>
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>

            <div class="flex items-center gap-2">
                <button id="theme-toggle-mobile" class="theme-toggle mobile-theme-toggle" aria-label="Toggle dark mode">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button id="mobile-menu-btn" class="mobile-menu-btn" aria-label="Open navigation menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>

        <div id="mobile-menu" class="mobile-dropdown hidden flex" role="menu">
            <a href="index.html#features" class="nav-link">Features</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="https://github.com/ravidorr/sticky-notes-chrome-extension" target="_blank" rel="noopener" class="nav-link">GitHub</a>
        </div>
    </nav>

    <main id="main-content" class="generate-key-page">
        <div class="container">
            <div class="key-form-card">
                <h1>Generate API Key</h1>
                <p>Sign in with Google to generate an API key for the Sticky Notes API or MCP server.</p>
                
                <div id="step1">
                    <button id="signInBtn" class="btn btn-primary">Sign in with Google</button>
                    <p id="userInfo" class="user-info" style="display: none;"></p>
                </div>
                
                <div id="step2" style="display: none;">
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">
                    
                    <div class="form-group">
                        <label for="keyName">Key Name</label>
                        <input type="text" id="keyName" placeholder="My Integration" value="Cursor MCP">
                    </div>
                    
                    <div class="form-group">
                        <label for="scopes">Permissions</label>
                        <select id="scopes">
                            <option value="both">Read & Write (notes:read, notes:write)</option>
                            <option value="read">Read Only (notes:read)</option>
                            <option value="write">Write Only (notes:write)</option>
                        </select>
                    </div>
                    
                    <button id="generateBtn" class="btn btn-primary">Generate API Key</button>
                </div>
                
                <p id="error" class="error-msg" style="display: none;"></p>
            </div>
            
            <div id="result" class="result-card" style="display: none;">
                <h3>Your API Key</h3>
                <div class="warning-box">
                    Save this key now - it won't be shown again!
                </div>
                <div class="key-display" id="apiKeyDisplay"></div>
                
                <div class="btn-group">
                    <button id="copyBtn" class="btn btn-secondary">Copy to Clipboard</button>
                    <a href="dashboard.html" class="btn btn-primary">Go to Dashboard</a>
                </div>
                
                <h4 style="margin-top: 24px; margin-bottom: 12px;">Test your key:</h4>
                <div class="curl-example" id="curlExample"></div>
            </div>
        </div>
    </main>

    <script type="module" src="js/scripts.js"></script>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCqdVVAamQ9yrUkbCWRtPPtevdOK0_PrRM",
            authDomain: "sticky-notes-chrome-extension.firebaseapp.com",
            projectId: "sticky-notes-chrome-extension",
            storageBucket: "sticky-notes-chrome-extension.firebasestorage.app",
            messagingSenderId: "413613230006",
            appId: "1:413613230006:web:1bb39d70bd4976e95ae317"
        };

        const API_URL = 'https://us-central1-sticky-notes-chrome-extension.cloudfunctions.net/api';

        let app, auth, currentUser, idToken;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
        } catch (e) {
            showError('Firebase initialization failed: ' + e.message);
        }

        function showError(msg) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        document.getElementById('signInBtn').addEventListener('click', async () => {
            hideError();
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                idToken = await currentUser.getIdToken();
                
                document.getElementById('userInfo').textContent = `Signed in as: ${currentUser.email}`;
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('signInBtn').textContent = 'Signed In';
                document.getElementById('signInBtn').disabled = true;
                document.getElementById('step2').style.display = 'block';
            } catch (error) {
                showError('Sign in failed: ' + error.message);
            }
        });

        document.getElementById('generateBtn').addEventListener('click', async () => {
            hideError();
            const name = document.getElementById('keyName').value || 'API Key';
            const scopeChoice = document.getElementById('scopes').value;
            
            let scopes;
            if (scopeChoice === 'read') scopes = ['notes:read'];
            else if (scopeChoice === 'write') scopes = ['notes:write'];
            else scopes = ['notes:read', 'notes:write'];

            try {
                const response = await fetch(`${API_URL}/keys`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, scopes })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to generate key');
                }

                document.getElementById('apiKeyDisplay').textContent = data.key;
                document.getElementById('curlExample').textContent = 
                    `curl "${API_URL}/notes" \\\n  -H "Authorization: Bearer ${data.key}"`;
                document.getElementById('result').style.display = 'block';
                
                window.generatedKey = data.key;
            } catch (error) {
                showError('Failed to generate key: ' + error.message);
            }
        });

        document.getElementById('copyBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(window.generatedKey);
            const btn = document.getElementById('copyBtn');
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy to Clipboard', 2000);
        });
    </script>
</body>
</html>
